---
phase: 04.1-technical-pivot-bus-migration-to-go
plan: 03
type: execute
depends_on: ["04.1-02"]
files_modified: [bus/go/internal/validator/validator.go, bus/go/internal/validator/validator_test.go, bus/go/pkg/contracts/event.go, bus/go/pkg/contracts/incident.go, bus/go/Makefile]
---

<objective>
Implement JSON Schema validation and code generation pipeline.

Purpose: Add contract validation to EventBus and generate Go structs from schemas
Output: ContractValidator package, generated Go structs, working Makefile generate target
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-RESEARCH.md
@.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-02-SUMMARY.md
@bus/contracts/event.schema.json
@bus/contracts/incident.schema.json
@bus/contracts/decision.schema.json
@bus/python/orion_bus/validator.py

**Tech Stack Available**:
- Go module with go-redis/v9, kaptinlin/jsonschema (Plan 01)
- EventBus with Publish/Subscribe (Plan 02)
- 8 JSON Schema contracts in bus/contracts/

**Established Patterns**:
- Contract validation mandatory at boundaries
- Fail-fast on validation errors
- All messages include version, timestamp, UUIDs

**Constraining Decisions**:
- Plan 02: EventBus core implemented
- RESEARCH.md: Hybrid approach - generate structs + runtime validation
- RESEARCH.md: kaptinlin/jsonschema for Draft 2020-12, omissis/go-jsonschema for generation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ContractValidator with kaptinlin/jsonschema</name>
  <files>bus/go/internal/validator/validator.go, bus/go/internal/validator/validator_test.go</files>
  <action>
    Create ContractValidator in internal/validator/validator.go for runtime JSON Schema validation.

    **Struct definition**:
    ```go
    type ContractValidator struct {
        schemas map[string]*jsonschema.Schema
        logger  *log.Logger
    }
    ```

    **Constructor (NewContractValidator)**:
    - Accept contracts directory path
    - Load all *.schema.json files
    - Compile schemas using kaptinlin/jsonschema
    - Store in schemas map (key: "event", "incident", etc. - omit .schema.json suffix)
    - Return error if any schema fails to compile

    **Methods**:

    1. `Validate(message map[string]interface{}, contractType string) error`
       - Look up schema by contractType
       - Return error if schema not found
       - Validate message against schema
       - Return validation error with full error details (use schema.Validate)
       - DO NOT suppress validation errors

    2. `LoadSchema(path string) (*jsonschema.Schema, error)` (private helper)
       - Read JSON file
       - Compile schema with kaptinlin/jsonschema
       - Return compiled schema or error

    **Unit tests** (validator_test.go):
    1. `TestValidate_ValidEvent_NoError` - Valid event.schema.json message passes
    2. `TestValidate_MissingRequiredField_ReturnsError` - Missing "event_id" fails
    3. `TestValidate_InvalidTimestamp_ReturnsError` - Malformed timestamp fails
    4. `TestValidate_UnknownContractType_ReturnsError` - Unknown type fails
    5. `TestValidate_AdditionalProperties_ReturnsError` - Extra fields fail (additionalProperties: false)

    Use actual schema files from bus/contracts/ in tests. Create test fixtures in validator_test.go.

    Follow RESEARCH.md guidance: kaptinlin/jsonschema supports Draft 2020-12, which matches ORION's existing contracts.
  </action>
  <verify>go test ./internal/validator -v passes all 5 tests</verify>
  <done>ContractValidator validates messages against JSON Schema, tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Implement Makefile generate target with go-jsonschema</name>
  <files>bus/go/Makefile</files>
  <action>
    Update Makefile `generate` target to generate Go structs from JSON Schema files.

    **Tool**: Install `omissis/go-jsonschema` if not present:
    ```bash
    go install github.com/omissis/go-jsonschema/cmd/gojsonschema@latest
    ```

    **Generate target implementation**:
    ```makefile
    generate:
        @echo "Generating Go structs from JSON Schema..."
        @which gojsonschema >/dev/null 2>&1 || (echo "Installing go-jsonschema..." && go install github.com/omissis/go-jsonschema/cmd/gojsonschema@latest)
        @mkdir -p pkg/contracts
        @for schema in ../contracts/*.schema.json; do \
            name=$$(basename $$schema .schema.json); \
            gojsonschema \
                --package contracts \
                --output pkg/contracts/$$name.go \
                --only-models \
                --tags json \
                $$schema; \
        done
        @go fmt pkg/contracts/*.go
        @echo "Generated structs in pkg/contracts/"
    ```

    **Options explanation** (from RESEARCH.md):
    - `--package contracts`: Package name
    - `--output`: Output file per schema
    - `--only-models`: Skip HTTP handlers (not needed)
    - `--tags json`: Add JSON marshal tags

    **Clean target update**:
    Add `rm -rf pkg/contracts/*.go` to clean generated files.

    **Test the generate target**:
    - Run `make generate`
    - Verify pkg/contracts/event.go, incident.go, decision.go created
    - Verify structs have JSON tags
    - Verify `go build ./pkg/contracts` compiles

    DO NOT commit generated files to git (add pkg/contracts/*.go to .gitignore, keep .gitkeep).
  </action>
  <verify>make generate creates Go structs, go build ./pkg/contracts succeeds</verify>
  <done>Makefile generate target works, creates type-safe Go structs from schemas</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation into EventBus</name>
  <files>bus/go/internal/bus/bus.go, bus/go/internal/bus/bus_test.go</files>
  <action>
    Update EventBus to use ContractValidator for publish-time validation.

    **Changes to bus.go**:

    1. Add validator field to EventBus struct:
       ```go
       type EventBus struct {
           client       *redis.Client
           validator    *validator.ContractValidator  // NEW
           streamPrefix string
           maxLen       int64
           logger       *log.Logger
       }
       ```

    2. Update NewEventBus constructor:
       - Accept contractsDir parameter
       - Create ContractValidator
       - Return error if validator initialization fails

    3. Update Publish method:
       - Call validator.Validate(message, contractType) BEFORE XAdd
       - Return validation error immediately (fail-fast)
       - Log validation failures at ERROR level

    **Changes to bus_test.go**:

    1. Add test: `TestPublish_InvalidMessage_ReturnsValidationError`
       - Publish message missing required field
       - Verify validation error returned
       - Verify message NOT published to stream

    2. Update existing tests to provide contracts directory:
       - Copy schema files to temp directory in test setup
       - Pass temp directory to NewEventBus
       - Use t.Cleanup() to remove temp directory

    **Pattern from ARCHITECTURE.md**:
    - Contract validation is mandatory at all boundaries
    - Invalid messages are rejected immediately (fail-fast)
    - No message reaches Redis without validation

    Ensure all tests still pass after integration.
  </action>
  <verify>go test ./internal/bus -v passes, including new validation test</verify>
  <done>EventBus validates all published messages, fails fast on invalid contracts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make generate` creates Go structs from all 8 schemas
- [ ] `go test ./internal/... -v -race` passes all tests
- [ ] EventBus rejects invalid messages before publishing
- [ ] Generated structs have proper JSON tags
- [ ] Coverage maintained >80% after validation integration
</verification>

<success_criteria>

- ContractValidator validates messages against JSON Schema Draft 2020-12
- Makefile generate target creates Go structs from schemas
- EventBus integrates validation (fail-fast on invalid messages)
- 6 unit tests for validator (valid + 5 error cases)
- 1 integration test for EventBus validation
- All tests pass with race detector
- Generated code compiles and includes JSON tags
  </success_criteria>

<output>
After completion, create `.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-03-SUMMARY.md`:

# Phase 4.1 Plan 03: Validation & Code Generation Summary

**Contract validation operational with generated Go structs**

## Accomplishments

- ContractValidator using kaptinlin/jsonschema (Draft 2020-12)
- 6 unit tests for validator (valid + error cases)
- Makefile generate target with omissis/go-jsonschema
- Generated Go structs for all 8 contracts
- EventBus integrated with validation (fail-fast)
- 1 integration test verifying publish-time validation

## Files Created/Modified

- `bus/go/internal/validator/validator.go` - ContractValidator implementation
- `bus/go/internal/validator/validator_test.go` - 6 unit tests
- `bus/go/Makefile` - Updated generate target
- `bus/go/internal/bus/bus.go` - Integrated validation
- `bus/go/internal/bus/bus_test.go` - Added validation test
- `bus/go/pkg/contracts/*.go` - Generated structs (8 files)

## Decisions Made

- Using kaptinlin/jsonschema for runtime validation (Draft 2020-12)
- Using omissis/go-jsonschema for struct generation
- Fail-fast on validation errors (no publish to Redis)
- Generated files not committed (add to .gitignore)
- Validation occurs before XAdd (fail early)

## Issues Encountered

None

## Next Step

Ready for 04.1-04-PLAN.md (Migration Strategy & Cutover)
</output>
