---
phase: 04.1-technical-pivot-bus-migration-to-go
plan: 04
type: execute
depends_on: ["04.1-03"]
files_modified: [bus/go/cmd/orion-bus/main.go, bus/go/scripts/migration-validate.sh, bus/go/docs/MIGRATION.md, core/brain/brain.py, core/guardian/guardian.py]
---

<objective>
Implement migration strategy with parallel operation and validation.

Purpose: Enable zero-downtime cutover from Python bus to Go bus
Output: Migration documentation, validation script, updated Python modules to support Go bus
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-RESEARCH.md
@.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-03-SUMMARY.md
@bus/go/internal/bus/bus.go
@bus/python/orion_bus/bus.py
@core/brain/brain.py
@core/guardian/guardian.py

**Tech Stack Available**:
- Go EventBus with validation (Plans 01-03)
- Python EventBus operational (current production)
- Redis Streams (shared between Python and Go)

**Established Patterns**:
- Consumer groups for parallel consumers
- Contract validation at boundaries
- Graceful shutdown with timeouts

**Constraining Decisions**:
- Plan 03: Go bus validates contracts
- RESEARCH.md: Three-phase migration (parallel → consumer migration → cutover)
- ARCHITECTURE.md: Zero downtime required, no message loss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete Go bus main.go with full EventBus integration</name>
  <files>bus/go/cmd/orion-bus/main.go</files>
  <action>
    Update main.go to run full EventBus service with health endpoint.

    **Configuration** (from command-line flags or env vars):
    - `--redis-addr` (default: "localhost:6379")
    - `--contracts-dir` (default: "../contracts")
    - `--log-level` (default: "info")
    - `--stream-prefix` (default: "orion")
    - `--max-stream-len` (default: 10000)
    - `--http-port` (default: 8080) - Health check endpoint

    **Main flow**:
    1. Parse flags
    2. Set up logger with configured level
    3. Create Redis client with connection pool config from RESEARCH.md:
       - PoolSize: 100
       - MinIdleConns: 10
       - ConnMaxLifetime: 1 hour
    4. Create ContractValidator (contracts directory)
    5. Create EventBus (Redis client, validator, prefix, maxlen)
    6. Start HTTP server with /health endpoint (returns {"status": "ok"})
    7. Set up graceful shutdown with signal.NotifyContext (SIGINT, SIGTERM)
    8. On shutdown: close HTTP server, close Redis client
    9. Log startup and shutdown events

    **Health endpoint**:
    - GET /health → 200 {"status": "ok", "service": "orion-bus-go"}
    - Used by systemd and migration validation

    **Logging**:
    - Startup: "ORION Bus (Go) starting on :8080"
    - Shutdown: "ORION Bus (Go) shutting down gracefully"
    - Include version in logs (hardcode "0.1.0-alpha" for now)

    Follow RESEARCH.md patterns for graceful shutdown (25s timeout).
  </action>
  <verify>./bin/orion-bus starts, /health returns 200, responds to Ctrl+C cleanly</verify>
  <done>Go bus runs as full service with health endpoint and graceful shutdown</done>
</task>

<task type="auto">
  <name>Task 2: Create migration validation script</name>
  <files>bus/go/scripts/migration-validate.sh</files>
  <action>
    Create bash script to validate Go bus behavior matches Python bus.

    **Script functionality**:

    1. **Prerequisites check**:
       - Verify Redis running (redis-cli ping)
       - Verify Python bus health (if health endpoint exists)
       - Verify Go bus health (curl localhost:8080/health)

    2. **Message roundtrip test**:
       - Publish test event via Python bus
       - Consume via Go bus (verify contract validation)
       - Publish test event via Go bus
       - Consume via Python bus (verify backward compatibility)
       - Report success/failure for each direction

    3. **Consumer group test**:
       - Create consumer group via Go bus
       - Verify group exists (redis-cli XINFO GROUPS)
       - Publish 10 messages
       - Verify all consumed and acknowledged
       - Check for pending messages (should be 0)

    4. **Validation test**:
       - Attempt to publish invalid message via Go bus
       - Verify rejection (does not appear in stream)
       - Verify error logged

    **Exit codes**:
    - 0: All tests passed
    - 1: Prerequisites failed
    - 2: Message roundtrip failed
    - 3: Consumer group test failed
    - 4: Validation test failed

    **Output format**:
    - Clear pass/fail for each test
    - Summary at end with counts
    - Suggestions for failures

    Make script executable (chmod +x).
  </action>
  <verify>./scripts/migration-validate.sh runs and reports results</verify>
  <done>Validation script verifies Go/Python bus interoperability</done>
</task>

<task type="auto">
  <name>Task 3: Document migration strategy and create cutover plan</name>
  <files>bus/go/docs/MIGRATION.md</files>
  <action>
    Create comprehensive migration documentation following RESEARCH.md three-phase strategy.

    **Document structure**:

    ## Phase 1: Parallel Operation (Week 1)
    - Deploy Go bus alongside Python bus
    - Both publish to same Redis Streams
    - Python consumers remain on Python bus
    - Go bus observes traffic (logging only, no consumers yet)
    - Validation: Run migration-validate.sh daily, verify no contract violations

    ## Phase 2: Consumer Migration (Week 2)
    - Migrate consumers one module at a time:
      1. orion-memory (lowest risk - read-only)
      2. orion-guardian (correlation logic - test thoroughly)
      3. orion-brain (decision logic - critical path)
      4. orion-commander (action execution - high risk)
      5. orion-approval (approval coordination)
    - For each module:
      - Update to consume from Go bus consumer group
      - Run integration tests
      - Monitor for 24 hours
      - Rollback procedure: revert to Python bus consumer group
    - Validation: Check consumer group lag, verify no message loss

    ## Phase 3: Full Cutover (Week 3)
    - Stop Python bus publishers
    - All modules publish to Go bus only
    - Monitor for 1 week (burn-in period)
    - After successful burn-in: Remove Python bus code
    - Update systemd services

    **Rollback Plan**:
    - At any phase, can revert to Python bus
    - Consumer groups are independent (no coordination needed)
    - Redis Streams retain messages (no data loss)

    **Success Criteria**:
    - Zero downtime during migration
    - No message loss (verify via message IDs)
    - Go bus memory < 100MB (Python bus ~150MB)
    - Go bus latency p95 < 10ms (Python bus ~50ms)

    **Monitoring**:
    - Redis Streams lag (XPENDING)
    - Go bus memory (RSS)
    - Contract validation errors (should be zero)
    - Consumer processing rate

    **Emergency Stop**:
    - If validation failures > 1%, halt migration
    - If memory > 150MB, investigate before proceeding
    - If consumer lag > 1000 messages, investigate

    Include links to validation script, rollback procedures, and contact info (logs location).
  </action>
  <verify>MIGRATION.md is complete, readable, includes all three phases</verify>
  <done>Migration documentation provides clear cutover plan with rollback strategy</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./bin/orion-bus` starts and serves /health endpoint
- [ ] `./scripts/migration-validate.sh` runs validation tests
- [ ] MIGRATION.md documents all three migration phases
- [ ] Rollback plan clearly documented
- [ ] Success criteria and monitoring defined
</verification>

<success_criteria>

- Go bus runs as full service with health endpoint
- Migration validation script tests Go/Python interoperability
- MIGRATION.md documents three-phase strategy (parallel → consumer migration → cutover)
- Rollback plan defined for each phase
- Success criteria: zero downtime, no message loss, <100MB memory
- Phase 4.1 complete: Go bus ready for parallel deployment
  </success_criteria>

<output>
After completion, create `.planning/phases/04.1-technical-pivot-bus-migration-to-go/04.1-04-SUMMARY.md`:

# Phase 4.1 Plan 04: Migration Strategy Summary

**Go bus ready for production migration with zero-downtime strategy**

## Accomplishments

- Go bus main.go complete with health endpoint
- Migration validation script (tests Go/Python interoperability)
- MIGRATION.md documents three-phase cutover strategy
- Rollback plan defined for each migration phase
- Success criteria and monitoring plan

## Files Created/Modified

- `bus/go/cmd/orion-bus/main.go` - Full service implementation
- `bus/go/scripts/migration-validate.sh` - Validation script
- `bus/go/docs/MIGRATION.md` - Migration documentation

## Decisions Made

- Three-phase migration: Parallel (Week 1) → Consumer Migration (Week 2) → Full Cutover (Week 3)
- Health endpoint on :8080 for systemd monitoring
- Rollback possible at any phase (consumer groups independent)
- Burn-in period: 1 week after full cutover before removing Python code
- Emergency stop criteria: >1% validation failures, >150MB memory, >1000 message lag

## Issues Encountered

None

## Next Phase Readiness

**Phase 4.1 Complete**: Go bus implementation ready for parallel deployment.

**Before Phase 5 (AI Council)**:
- Execute migration plan (3 weeks)
- Validate performance targets (1000 msg/sec, <10ms p95, <100MB memory)
- Burn-in period complete
- Python bus removed

**Blockers**:
- None (Go bus can deploy in parallel immediately)

**Recommendations**:
- Start Week 1 (Parallel Operation) immediately
- Run migration-validate.sh daily during Week 1
- Monitor Redis Streams lag and Go bus memory
- Do NOT proceed to Phase 5 until migration complete and burn-in passed

---

## Phase 4.1 Summary

**TECHNICAL PIVOT COMPLETE**: orion-bus rewritten in Go with zero-downtime migration path.

### What Shipped
- Go module with go-redis/v9, kaptinlin/jsonschema, graceful shutdown
- EventBus with Publish/Subscribe, consumer groups, validation
- ContractValidator with JSON Schema Draft 2020-12 support
- Code generation pipeline (Makefile generate)
- Migration strategy with validation script
- 15 unit tests passing (bus, validator, shutdown)

### Performance Targets
- Throughput: 1,000 msg/sec (100x headroom)
- Latency (p95): <10ms
- Memory (RSS): <100MB (vs Python ~150MB)
- Concurrent consumers: 20+ (ready for Phase 5 AI Council)

### Migration Timeline
- Week 1: Parallel operation (observation)
- Week 2: Consumer migration (one module at a time)
- Week 3: Full cutover + burn-in
- Total: 3 weeks to production

### Ready For
- Parallel deployment alongside Python bus
- Phase 5 AI Council (after migration complete)
</output>
