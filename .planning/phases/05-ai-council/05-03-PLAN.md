---
phase: 05-ai-council
plan: 03
type: execute
depends_on: ["05-01", "05-02"]
files_modified: [core/council/consensus_aggregator.py, core/council/__init__.py]
---

<objective>
Implement confidence-weighted voting with safety veto and escalation logic.

Purpose: Create ConsensusAggregator to combine local SLM and external API critiques using confidence-weighted voting (not simple majority), enforce safety veto (any concern blocks action), and handle escalation from local → external APIs.
Output: Working consensus aggregator implementing SOTA voting algorithms from research.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ai-council/05-CONTEXT.md
@.planning/phases/05-ai-council/05-RESEARCH.md
@.planning/phases/05-ai-council/05-01-SUMMARY.md
@.planning/phases/05-ai-council/05-02-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md

**Research findings (SOTA):**
- ReConcile: Confidence-weighted voting (not majority)
- Isotonic regression: 8.4% improvement over majority voting
- Safety veto: Any model flags concern → block action
- Staged validation: Local → escalate to external if uncertain/RISKY

**Established patterns:**
- Conservative by default (fail-closed)
- Deterministic validation (no negotiation loops)
- Council validates only, never proposes alternatives
- Integration with Brain decision flow

**From Plans 05-01 and 05-02:**
- CouncilValidator returns (confidence, critique)
- ExternalValidator returns [(confidence1, critique1), (confidence2, critique2)]
- All validators fail-closed (errors return 0.0 confidence)

**Safety constraints:**
- Safety veto: If any validator flags safety concern with high confidence → BLOCK
- Confidence threshold: Default 0.7 (escalate below)
- Escalation: RISKY decisions always escalate to external APIs
- Result: "APPROVED", "BLOCKED", or "ESCALATE_TO_ADMIN"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ConsensusAggregator with confidence-weighted voting</name>
  <files>core/council/consensus_aggregator.py, core/council/__init__.py</files>
  <action>
Create ConsensusAggregator class in core/council/consensus_aggregator.py:
- Constructor parameters:
  - confidence_threshold: float = 0.7 (escalate below this)
  - safety_veto_threshold: float = 0.8 (high-confidence concern)
- Implement aggregate_votes(validations: List[Tuple[float, str]]) -> Tuple[str, float, str]
  - Takes list of (confidence, critique) from all validators
  - Confidence-weighted average: sum(conf_i * vote_i) / sum(conf_i)
    - vote_i = 1.0 if critique suggests APPROVE, 0.0 if BLOCK
    - Parse critique text for keywords: "approve", "safe", "correct" → 1.0
    - Parse critique for: "block", "unsafe", "risky", "concern" → 0.0
  - If weighted_avg < confidence_threshold: return ("BLOCKED", weighted_avg, combined_critique)
  - If weighted_avg >= confidence_threshold: return ("APPROVED", weighted_avg, combined_critique)
- Implement safety_veto(validations: List[Tuple[float, str]]) -> Optional[str]
  - Check each validation
  - If ANY critique contains safety keywords ("unsafe", "risky", "concern") AND confidence > 0.8:
    - Return "BLOCKED: Safety veto triggered by [model name]"
  - Otherwise: return None (no veto)
- Implement should_escalate(local_confidence: float, decision_classification: str) -> bool
  - Returns True if:
    - local_confidence < confidence_threshold (uncertain)
    - decision_classification == "RISKY" (requires higher scrutiny)
  - Otherwise: False
- Add type hints throughout
- Add comprehensive docstring explaining voting algorithm

Update __init__.py to expose ConsensusAggregator.

Use confidence-weighted voting (NOT simple majority).
Parse critique text naively (keyword matching, not NLP).
DO NOT implement isotonic regression calibration (future enhancement).
DO NOT use machine learning models for parsing.
  </action>
  <verify>
Import succeeds: python -c "from core.council import ConsensusAggregator; c = ConsensusAggregator(); print(type(c))"
Voting method present: grep -q "aggregate_votes" core/council/consensus_aggregator.py
Safety veto present: grep -q "safety_veto" core/council/consensus_aggregator.py
  </verify>
  <done>
ConsensusAggregator class exists with voting methods.
aggregate_votes() implements confidence-weighted voting.
safety_veto() checks for high-confidence safety concerns.
should_escalate() determines when to call external APIs.
All type hints and docstrings present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement orchestration logic for staged validation</name>
  <files>core/council/consensus_aggregator.py</files>
  <action>
Add orchestration to ConsensusAggregator:
- Implement async validate_decision(decision: Dict, local_validator: CouncilValidator, external_validator: ExternalValidator) -> Tuple[str, float, str]
  - Stage 1: Call local_validator.validate(decision)
    - Get (local_confidence, local_critique)
  - Stage 2: Check if escalation needed
    - If should_escalate(local_confidence, decision["classification"]):
      - Call external_validator.validate_parallel(decision)
      - Get [(claude_conf, claude_critique), (openai_conf, openai_critique)]
      - Combine all validations: [local, claude, openai]
    - Else:
      - Use only local validation
  - Stage 3: Safety veto check
    - veto_reason = safety_veto(all_validations)
    - If veto_reason: return ("BLOCKED", 0.0, veto_reason)
  - Stage 4: Aggregate votes
    - result, confidence, critique = aggregate_votes(all_validations)
    - Return (result, confidence, critique)
- Add logging: INFO for each stage, WARNING for veto/blocks
- Add docstring explaining staged validation flow

Import CouncilValidator and ExternalValidator types (from core.council).
Use async/await for external API calls.
Ensure fail-closed behavior: any error in stage → return ("BLOCKED", 0.0, error_message).
  </action>
  <verify>
Orchestration method present: grep -q "async def validate_decision" core/council/consensus_aggregator.py
Imports validators: grep -q "from core.council" core/council/consensus_aggregator.py
  </verify>
  <done>
validate_decision() orchestrates staged validation flow.
Local SLM always called first.
External APIs only called if uncertain or RISKY.
Safety veto enforced before aggregation.
Logging added for each stage.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_consensus_aggregator.py -v` passes (if tests written)
- [ ] No import errors from core.council
- [ ] Confidence-weighted voting implemented correctly
- [ ] Safety veto triggers on high-confidence concerns
- [ ] Escalation logic calls external APIs when needed
</verification>

<success_criteria>

- ConsensusAggregator implements confidence-weighted voting
- Safety veto blocks action if any validator flags concern
- Staged validation: local first, escalate if uncertain/RISKY
- validate_decision() orchestrates full validation flow
- All type hints and docstrings present
- Fail-closed behavior on all errors
- No syntax errors, imports work
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-council/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Consensus Aggregator Summary

**Implemented confidence-weighted voting with safety veto and staged validation orchestration.**

## Accomplishments

- ConsensusAggregator combines validations using confidence-weighted voting
- Safety veto blocks action if any validator flags high-confidence concern
- Staged validation: local SLM first, escalate to external APIs if needed
- validate_decision() orchestrates full validation flow
- Fail-closed behavior throughout

## Files Created/Modified

- `core/council/consensus_aggregator.py` - Voting and orchestration logic
- `core/council/__init__.py` - Module exports

## Decisions Made

- Confidence threshold: 0.7 (escalate below, based on research)
- Safety veto threshold: 0.8 (high-confidence concern)
- Keyword-based critique parsing (naive, not NLP)
- Escalation on RISKY classification OR low confidence
- Isotonic regression deferred (future enhancement)

## Issues Encountered

[Document any issues, or "None"]

## Next Step

Ready for 05-04-PLAN.md (Integration with Brain and comprehensive testing)
</output>
