---
phase: 05-ai-council
plan: 04
type: execute
depends_on: ["05-01", "05-02", "05-03"]
files_modified: [bus/contracts/validation.schema.json, core/brain/brain.py, tests/test_council.py, tests/test_brain_with_council.py]
---

<objective>
Integrate AI Council with Brain decision flow and add comprehensive testing.

Purpose: Create validation contract schema, integrate Council validation into Brain's decision pipeline (optional validation layer), and ensure all Council components work together with comprehensive unit and integration tests.
Output: Fully integrated AI Council with Brain, validated by tests, ready for production use.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ai-council/05-CONTEXT.md
@.planning/phases/05-ai-council/05-RESEARCH.md
@.planning/phases/05-ai-council/05-01-SUMMARY.md
@.planning/phases/05-ai-council/05-02-SUMMARY.md
@.planning/phases/05-ai-council/05-03-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/TESTING.md
@core/brain/brain.py

**Current Brain flow:**
1. Consumes incident from Redis Streams
2. Applies policy (SAFE/RISKY classification)
3. Checks cooldown and circuit breaker
4. Emits decision (NO_ACTION, EXECUTE_SAFE_ACTION, REQUEST_APPROVAL)

**Council integration (optional layer):**
- AFTER Brain makes decision, BEFORE emitting to Redis
- Brain calls Council.validate_decision(decision)
- If Council returns "BLOCKED": Change decision to NO_ACTION
- If Council returns "APPROVED": Proceed with original decision
- Validation is OPTIONAL (disabled by default, enabled via config)

**Testing requirements:**
- 238 existing tests must still pass
- Unit tests for each Council component
- Integration test for full validation flow
- Mock Ollama, Claude, OpenAI (no real API calls in tests)

**Safety constraints:**
- Council cannot modify Brain decision (validate only)
- Council blocking is final (no Admin override in Phase 5)
- Validation failure = fail-closed (treat as BLOCKED)
- All existing safety mechanisms (cooldown, circuit breaker) unchanged
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation contract schema and integrate with Brain</name>
  <files>bus/contracts/validation.schema.json, core/brain/brain.py</files>
  <action>
Create validation.schema.json in bus/contracts/:
- JSON Schema for Council validation results
- Required fields:
  - version: const "1.0"
  - validation_id: string (UUID format)
  - decision_id: string (UUID of decision validated)
  - result: enum ["APPROVED", "BLOCKED"]
  - confidence: number (0.0 to 1.0)
  - critique: string (combined critique from validators)
  - validators_used: array of strings (["local", "claude", "openai"])
  - timestamp: string (ISO 8601 date-time)
  - source: const "orion-council"
- additionalProperties: false
- Follow existing contract patterns from other schemas

Update Brain class in core/brain/brain.py:
- Add optional council parameter to constructor: council: Optional[ConsensusAggregator] = None
- Update decide() method:
  - AFTER policy/cooldown/circuit breaker checks
  - BEFORE emitting decision to Redis
  - If council is not None:
    - Call await council.validate_decision(decision_dict, council_validator, external_validator)
    - Get (result, confidence, critique)
    - If result == "BLOCKED":
      - Change decision type to "NO_ACTION"
      - Update reasoning: "BLOCKED BY COUNCIL: {critique}"
      - Log WARNING
    - If result == "APPROVED":
      - Proceed with original decision
      - Log INFO
  - If council is None: Skip validation (existing behavior)
- Add logging: INFO when validation skipped, WARNING when blocked
- DO NOT make Council mandatory - it's an OPTIONAL layer
- DO NOT modify autonomy level enforcement (N0/N2/N3 unchanged)

Import ConsensusAggregator from core.council.
Add type hint for Optional council parameter.
Ensure backward compatibility (existing tests pass with council=None).
  </action>
  <verify>
Schema valid: python -c "import json; s = json.load(open('bus/contracts/validation.schema.json')); print('Valid')"
Brain integration: grep -q "council.validate_decision" core/brain/brain.py
  </verify>
  <done>
validation.schema.json created following ORION contract patterns.
Brain.decide() calls Council validation if council parameter provided.
Council blocking changes decision to NO_ACTION.
Backward compatibility maintained (council=None skips validation).
Logging added for validation results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for Council components</name>
  <files>tests/test_council.py</files>
  <action>
Create tests/test_council.py with comprehensive unit tests:
- Use pytest framework with markers (@pytest.mark.unit)
- Test CouncilValidator:
  - test_validate_returns_confidence_and_critique
  - test_validate_blocks_on_insufficient_ram (mock MemoryManager)
  - test_validate_fails_closed_on_ollama_error (mock ollama exception)
  - test_validate_enforces_30_second_timeout
- Test MemoryManager:
  - test_check_resources_blocks_below_4gb (mock psutil.virtual_memory)
  - test_check_resources_allows_sufficient_ram
  - test_temperature_monitoring_optional (vcgencmd unavailable)
- Test ExternalValidator:
  - test_validate_with_claude_returns_confidence (mock anthropic client)
  - test_validate_with_openai_returns_confidence (mock openai client)
  - test_validate_parallel_calls_both_apis (mock asyncio.gather)
  - test_missing_api_keys_handled_gracefully
  - test_retry_logic_on_connection_error (mock APIConnectionError)
  - test_authentication_error_fails_immediately (no retry)
- Test ConsensusAggregator:
  - test_confidence_weighted_voting_approves_high_confidence
  - test_confidence_weighted_voting_blocks_low_confidence
  - test_safety_veto_blocks_on_high_confidence_concern
  - test_should_escalate_on_low_local_confidence
  - test_should_escalate_on_risky_classification
  - test_staged_validation_skips_external_on_high_local_confidence

Use pytest fixtures for common mocks.
Use fakeredis for any Redis interactions (match existing test patterns).
Mock external dependencies: ollama, anthropic, openai, psutil.
Follow existing test conventions from tests/test_brain.py structure.
DO NOT make real API calls in tests.
DO NOT require Ollama running locally.
  </action>
  <verify>
Tests exist: ls tests/test_council.py
Tests runnable: pytest tests/test_council.py -v --collect-only (lists tests without running)
  </verify>
  <done>
Comprehensive unit tests for all Council components.
All external dependencies mocked (no real API calls).
Tests follow ORION conventions (pytest, markers, fixtures).
Coverage for success paths, error paths, edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for Brain + Council flow</name>
  <files>tests/test_brain_with_council.py</files>
  <action>
Create tests/test_brain_with_council.py with integration tests:
- Use pytest framework with @pytest.mark.integration
- Test Brain with Council integration:
  - test_brain_council_approves_safe_decision
    - Create incident, Brain decides EXECUTE_SAFE_ACTION
    - Mock Council returns APPROVED
    - Verify decision proceeds unchanged
  - test_brain_council_blocks_unsafe_decision
    - Create incident, Brain decides EXECUTE_SAFE_ACTION
    - Mock Council returns BLOCKED (safety veto)
    - Verify decision changed to NO_ACTION
    - Verify reasoning includes "BLOCKED BY COUNCIL"
  - test_brain_without_council_unchanged
    - Brain with council=None
    - Verify existing behavior unchanged (backward compat)
  - test_council_escalates_risky_to_external_apis
    - Create RISKY incident
    - Mock local validator returns low confidence
    - Mock external validators called
    - Verify escalation logic works
  - test_council_validation_failure_fails_closed
    - Mock Council raises exception
    - Verify Brain catches and treats as BLOCKED
  - test_all_existing_tests_still_pass
    - Run full test suite: pytest tests/

Use mocks for all Council components (no real models).
Use fakeredis for event bus (match existing patterns).
Verify 238 existing tests still pass after integration.
Follow test structure from tests/test_brain_n2.py.
  </action>
  <verify>
Integration tests exist: ls tests/test_brain_with_council.py
All tests pass: pytest tests/ -v (238 existing + new Council tests)
  </verify>
  <done>
Integration tests verify Brain + Council flow.
Existing tests still pass (backward compatibility confirmed).
Council blocking behavior tested end-to-end.
Escalation logic tested with mocks.
Validation failure fails-closed verified.
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/ -v` passes (all 238 existing + new Council tests)
- [ ] No regressions in existing tests
- [ ] validation.schema.json validates against JSON Schema
- [ ] Brain with council=None behaves identically to before
- [ ] Council blocking changes decision to NO_ACTION
- [ ] All Council components have unit test coverage
</verification>

<success_criteria>

- validation.schema.json contract created
- Brain integrated with Council (optional validation layer)
- Council blocking changes decision to NO_ACTION
- Backward compatibility maintained (council=None)
- Comprehensive unit tests for all Council components
- Integration tests for Brain + Council flow
- All 238 existing tests still pass
- No syntax errors, all imports work
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-council/05-04-SUMMARY.md`:

# Phase 5 Plan 4: Integration & Testing Summary

**Integrated AI Council with Brain decision flow and added comprehensive testing.**

## Accomplishments

- validation.schema.json contract created following ORION patterns
- Brain integrated with Council as optional validation layer
- Council blocking changes Brain decision to NO_ACTION
- Backward compatibility maintained (council=None skips validation)
- Comprehensive unit tests for CouncilValidator, ExternalValidator, ConsensusAggregator, MemoryManager
- Integration tests for Brain + Council flow
- All 238 existing tests still pass + ~20 new Council tests

## Files Created/Modified

- `bus/contracts/validation.schema.json` - Council validation contract
- `core/brain/brain.py` - Integrated Council validation (optional)
- `tests/test_council.py` - Unit tests for all Council components
- `tests/test_brain_with_council.py` - Integration tests

## Decisions Made

- Council is OPTIONAL layer (disabled by default, enabled via constructor)
- Council blocking is final in Phase 5 (no Admin override yet)
- Validation failure = fail-closed (treat as BLOCKED)
- All existing Brain safety mechanisms (cooldown, circuit breaker) unchanged
- External dependencies mocked in tests (no real API calls)

## Issues Encountered

[Document any issues, or "None"]

## Next Phase Readiness

**Phase 5 Complete** ✅

AI Council implemented with:
- Local SLM validation (Gemma-2 2B via Ollama)
- External API validation (Claude + OpenAI)
- Confidence-weighted voting (SOTA algorithms)
- Safety veto enforcement
- Hardware-aware resource monitoring (Pi 5)
- Comprehensive testing (unit + integration)
- Brain integration (optional layer)

**Concerns for next phases:**
- Ollama must be installed and Gemma-2 2B model pulled (`ollama pull gemma2:2b`)
- API keys required for external validation (ANTHROPIC_API_KEY, OPENAI_API_KEY)
- Temperature monitoring may not work on all Pi 5 configurations (optional)
- Council adds 3-12 seconds latency to decision pipeline (acceptable per requirements)

**Phase 6 blockers:** None (Edge Integration can proceed)

**Phase 5 Performance Targets Met:**
- Local validation: 3-7 seconds ✅
- External validation: 2-5 seconds (parallel) ✅
- Total worst-case: <12 seconds ✅
- No OOM crashes (4GB RAM protection) ✅
- Fail-closed behavior throughout ✅
</output>
