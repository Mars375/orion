---
phase: 06-edge-integration
plan: 04
type: execute
depends_on: ["06-03"]
files_modified: [edge/internal/client/mqtt_test.go, edge/internal/client/redis_test.go, edge/integration_test.go, config/redis-edge.conf, docs/EDGE-SETUP.md]
---

<objective>
Add integration tests and document Redis remote configuration for Pi 4 connectivity.

Purpose: Verify edge agent works end-to-end and document how to configure Redis for remote access from Pi 4.
Output: Integration tests, Redis configuration guide, and edge setup documentation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06-edge-integration/06-CONTEXT.md
@.planning/phases/06-edge-integration/06-RESEARCH.md
@.planning/phases/06-edge-integration/06-03-SUMMARY.md
@bus/contracts/edge.command.schema.json
@bus/contracts/edge.telemetry.schema.json
@bus/contracts/edge.health.schema.json

**From RESEARCH.md:**
- Redis remote access: bind to private IP, require password or ACL
- Firewall: ufw allow from 192.168.x.0/24 to any port 6379
- TLS optional but recommended for sensitive environments

**From CONTEXT.md:**
- Pi 4 connects remotely to Redis on Pi 16GB
- Network security via home LAN (Tailscale for external)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for MQTT and Redis clients</name>
  <files>edge/internal/client/mqtt_test.go, edge/internal/client/redis_test.go</files>
  <action>
Add unit tests for the client packages.

**edge/internal/client/mqtt_test.go:**

Tests (mock MQTT broker not needed - test structure and error handling):
1. test_mqtt_client_config_parsing - NewMQTTClient parses broker URL correctly
2. test_mqtt_client_connect_timeout - Connect fails with clear error on timeout
3. test_mqtt_client_callback_registration - Callbacks are properly registered
4. test_mqtt_health_message_format - PublishHealth creates correct JSON structure

**edge/internal/client/redis_test.go:**

Tests (use miniredis or mock):
1. test_redis_client_connect_success - Connection succeeds with valid config
2. test_redis_client_connect_failure - Clear error on connection failure
3. test_redis_publish_telemetry_format - Telemetry published to correct stream
4. test_redis_subscribe_commands_handler - Command handler receives messages

Use github.com/alicebob/miniredis/v2 for Redis mocking (add to go.mod).
Do NOT require actual Redis/MQTT for unit tests.
  </action>
  <verify>cd /home/orion/orion/edge && go test -v ./internal/client/...</verify>
  <done>8 client unit tests passing, no external dependencies required</done>
</task>

<task type="auto">
  <name>Task 2: Create integration test for full agent lifecycle</name>
  <files>edge/integration_test.go</files>
  <action>
Create integration test that verifies the full agent lifecycle.

**edge/integration_test.go:**

Use build tag `// +build integration` so it's skipped by default.

Test scenarios (require Redis, skip MQTT for simplicity):

1. **test_agent_starts_and_publishes_health**
   - Start agent with mock Redis (miniredis)
   - Verify health endpoint returns OK
   - Verify heartbeat messages published to Redis stream
   - Stop agent cleanly

2. **test_watchdog_triggers_on_no_reset**
   - Start agent with short watchdog timeout (100ms)
   - Do NOT reset watchdog
   - Verify safe mode entered after timeout
   - Verify health shows safe_mode: true

3. **test_command_resets_watchdog**
   - Start agent with short watchdog timeout
   - Simulate command receipt (reset watchdog)
   - Verify safe mode NOT entered
   - Verify health shows safe_mode: false

4. **test_resume_command_exits_safe_mode**
   - Trigger safe mode via watchdog timeout
   - Send RESUME command
   - Verify safe mode exited
   - Verify health shows safe_mode: false

Run with: `go test -v -tags=integration ./...`

These tests use miniredis, not actual Redis, so they run fast and offline.
  </action>
  <verify>cd /home/orion/orion/edge && go test -v -tags=integration ./...</verify>
  <done>4 integration tests passing with miniredis, full lifecycle verified</done>
</task>

<task type="auto">
  <name>Task 3: Document Redis remote configuration and edge setup</name>
  <files>config/redis-edge.conf, docs/EDGE-SETUP.md</files>
  <action>
Create configuration and documentation for edge connectivity.

**config/redis-edge.conf:**
Create a Redis configuration snippet for enabling remote access from Pi 4:

```conf
# Redis configuration for ORION Edge Integration
# Add to /etc/redis/redis.conf on Pi 16GB (orion-core)

# Bind to private network interface (replace with actual IP)
# Default localhost only - this enables LAN access
bind 127.0.0.1 192.168.1.100

# Require password for edge devices
requirepass orion-edge-secret-changeme

# Alternative: Use ACL for granular control (Redis 6+)
# user orion-edge on >edgepassword ~orion:edge:* +@read +@write +@pubsub -@dangerous

# Connection limits
maxclients 100
timeout 300

# Memory limits (leave room for LLMs on Pi 16GB)
maxmemory 512mb
maxmemory-policy allkeys-lru
```

**docs/EDGE-SETUP.md:**
Create comprehensive setup guide:

```markdown
# ORION Edge Device Setup Guide

## Overview
This guide covers setting up a Raspberry Pi 4 as an ORION edge device (orion-edge).

## Prerequisites
- Raspberry Pi 4 (4GB or 8GB)
- Raspberry Pi OS 64-bit (Bookworm recommended)
- Network connectivity to orion-core (Pi 16GB)
- orion-edge binary (built with `make build-arm64`)

## 1. Redis Configuration (on Pi 16GB)

1. Edit Redis config: `sudo nano /etc/redis/redis.conf`
2. Add lines from config/redis-edge.conf
3. Restart Redis: `sudo systemctl restart redis`
4. Verify: `redis-cli -h 192.168.1.100 -a yourpassword ping`

## 2. Firewall Configuration (on Pi 16GB)

```bash
# Allow Redis from local network only
sudo ufw allow from 192.168.0.0/16 to any port 6379

# Verify
sudo ufw status
```

## 3. Deploy orion-edge (on Pi 4)

1. Copy binary: `scp bin/orion-edge-arm64 pi@pi4:/home/pi/orion-edge`
2. Make executable: `chmod +x /home/pi/orion-edge`
3. Create systemd service (optional)

## 4. Run orion-edge

```bash
./orion-edge \
  --device-id hexapod-1 \
  --redis-addr 192.168.1.100:6379 \
  --redis-password orion-edge-secret-changeme \
  --mqtt-broker tcp://192.168.1.100:1883 \
  --watchdog-timeout 5 \
  --heartbeat-interval 1
```

## 5. Verify Connectivity

```bash
# Check health endpoint
curl http://localhost:8081/health

# Should return:
# {"status":"ok","service":"orion-edge","device_id":"hexapod-1",...}
```

## 6. Safety Behavior

The Dead Man's Switch activates if:
- MQTT connection lost for >5 seconds
- No commands received for >5 seconds

When triggered:
- Robot enters "Sit & Freeze" safe state
- Health shows `safe_mode: true`
- Requires explicit RESUME command to exit

## Troubleshooting

### "Connection refused" to Redis
- Verify Redis bind address includes Pi 16GB's IP
- Verify firewall allows connection
- Verify password is correct

### Watchdog keeps triggering
- Check MQTT broker is running
- Verify Brain is sending heartbeats/commands
- Increase watchdog-timeout if network is slow

### Safe mode won't exit
- Send RESUME command from Brain
- Verify MQTT connection is established
- Check logs for errors
```
  </action>
  <verify>cat /home/orion/orion/config/redis-edge.conf && cat /home/orion/orion/docs/EDGE-SETUP.md | head -50</verify>
  <done>Redis config snippet and edge setup documentation created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v ./internal/client/...` passes (8 unit tests)
- [ ] `go test -v -tags=integration ./...` passes (4 integration tests)
- [ ] config/redis-edge.conf contains bind, requirepass, maxmemory settings
- [ ] docs/EDGE-SETUP.md covers prerequisites, Redis config, firewall, deployment, safety behavior
- [ ] All edge tests run without actual Redis/MQTT (use mocks)
- [ ] Documentation explains Dead Man's Switch behavior
</verification>

<success_criteria>
- Client packages have unit tests with mocks
- Integration tests verify full agent lifecycle
- Redis configuration documented for remote access
- Edge setup guide comprehensive and actionable
- Phase 6 complete - edge agent ready for hardware integration (Phase 7+)
</success_criteria>

<output>
After completion, create `.planning/phases/06-edge-integration/06-04-SUMMARY.md`:

# Phase 6 Plan 04: Integration & Documentation Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Key decisions and rationale]

## Issues Encountered
- [Problems and resolutions]

## Phase 6 Complete

Phase 6: Edge Integration complete. The orion-edge-agent provides:
- Contract-validated communication with Brain
- Dead Man's Switch for network loss safety
- "Sit & Freeze" safe state (kinematics stub)
- Remote Redis connectivity from Pi 4

**Next Phase:** Phase 7 (Compute Expansion) or hardware integration testing

**Phase 6 does NOT include:**
- Actual servo control (requires periph.io + hardware)
- Inverse kinematics implementation
- Physical robot testing
- MQTT broker deployment
</output>
