---
phase: 06-edge-integration
plan: 02
type: execute
depends_on: ["06-01"]
files_modified: [edge/go.mod, edge/go.sum, edge/cmd/orion-edge/main.go, edge/internal/client/mqtt.go, edge/internal/client/redis.go, edge/internal/config/config.go]
---

<objective>
Create the orion-edge-agent Go project foundation with MQTT and Redis clients.

Purpose: Establish the edge agent binary that will run on Pi 4, connecting to Brain's Redis and MQTT broker.
Output: Buildable Go binary with MQTT client (paho.golang) and Redis client (go-redis) for ARM64.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06-edge-integration/06-CONTEXT.md
@.planning/phases/06-edge-integration/06-RESEARCH.md
@.planning/phases/06-edge-integration/06-01-SUMMARY.md
@bus/go/go.mod
@bus/go/cmd/orion-bus/main.go

**Prior Decisions:**
- Phase 4.1: Go bus pattern (flag-based config, graceful shutdown, health endpoint)
- Go for edge agent (matches bus, ARM cross-compilation, static binaries)

**From RESEARCH.md:**
- paho.golang/autopaho for MQTT (auto-reconnect, connection callbacks)
- go-redis/v9 for Redis Streams
- Cross-compile: CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build

**From CONTEXT.md:**
- Pi 4 connects remotely to Redis on Pi 16GB
- MQTT for commands (low latency), Redis Streams for telemetry/audit
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize orion-edge-agent Go module with dependencies</name>
  <files>edge/go.mod, edge/go.sum</files>
  <action>
Create edge/ directory at project root and initialize Go module.

```bash
mkdir -p /home/orion/orion/edge
cd /home/orion/orion/edge
go mod init github.com/yourusername/orion/edge
```

Add dependencies (match Go bus versions where possible):
- github.com/redis/go-redis/v9 (same as bus/go)
- github.com/eclipse/paho.golang v0.21.0 (latest stable with autopaho)

Create Makefile similar to bus/go/Makefile:
- `make build`: Build for local platform
- `make build-arm64`: Cross-compile for Pi 4 (CGO_ENABLED=0 GOOS=linux GOARCH=arm64)
- `make test`: Run tests with race detector
- `make clean`: Remove bin/

Do NOT add periph.io yet - hardware interfacing is out of scope for Phase 6.
  </action>
  <verify>cd /home/orion/orion/edge && go mod tidy && go mod verify</verify>
  <done>edge/go.mod exists with redis and paho.golang dependencies, Makefile created</done>
</task>

<task type="auto">
  <name>Task 2: Create configuration and client packages</name>
  <files>edge/internal/config/config.go, edge/internal/client/mqtt.go, edge/internal/client/redis.go</files>
  <action>
Create internal packages for configuration and clients.

**edge/internal/config/config.go:**
- Config struct with fields:
  - DeviceID string (e.g., "hexapod-1")
  - RedisAddr string (Pi 16GB address, e.g., "192.168.1.100:6379")
  - RedisPassword string
  - MQTTBrokerURL string (e.g., "tcp://192.168.1.100:1883")
  - MQTTClientID string (derived from DeviceID)
  - HeartbeatIntervalSec int (default: 1)
  - WatchdogTimeoutSec int (default: 5, Dead Man's Switch timeout)
  - StreamPrefix string (default: "orion")
- LoadFromFlags() function to parse command-line flags
- Validate() method to check required fields

**edge/internal/client/redis.go:**
- RedisClient struct wrapping go-redis client
- NewRedisClient(addr, password string) function
- Connect(ctx) error - establish connection with timeout
- Close() error
- PublishTelemetry(ctx, telemetry map[string]interface{}) error - XAdd to telemetry stream
- SubscribeCommands(ctx, handler func(map[string]interface{}) error) error - XReadGroup from command stream

**edge/internal/client/mqtt.go:**
- MQTTClient struct wrapping autopaho ConnectionManager
- NewMQTTClient(brokerURL, clientID string) function
- Connect(ctx) error - establish connection with auto-reconnect
- Close() error
- OnConnectionUp callback (for resuming operations)
- OnConnectionDown callback (for Dead Man's Switch trigger)
- PublishHealth(ctx, health map[string]interface{}) error - QoS 1
- SubscribeCommands(ctx, handler func(topic string, payload []byte)) error

Both clients should log connection state changes for debugging.
  </action>
  <verify>cd /home/orion/orion/edge && go build ./...</verify>
  <done>Config and client packages compile, clients have Connect/Close methods</done>
</task>

<task type="auto">
  <name>Task 3: Create main.go entry point with basic lifecycle</name>
  <files>edge/cmd/orion-edge/main.go</files>
  <action>
Create main entry point following bus/go patterns.

**edge/cmd/orion-edge/main.go:**

1. Parse flags using config.LoadFromFlags()
2. Initialize logger with device ID prefix
3. Create Redis client and connect (fail-fast if Brain unreachable)
4. Create MQTT client and connect (fail-fast if broker unreachable)
5. Start HTTP health endpoint on configurable port (default: 8081)
   - GET /health returns {"status":"ok","service":"orion-edge","device_id":"...","version":"0.1.0"}
6. Start goroutine: periodic heartbeat publisher (every HeartbeatIntervalSec)
7. Wait for shutdown signal (SIGINT, SIGTERM)
8. Graceful shutdown: stop heartbeat → close MQTT → close Redis (15s timeout)

Flags (similar to bus/go):
- --device-id: Edge device identifier (required)
- --redis-addr: Brain's Redis address (default: localhost:6379)
- --redis-password: Redis password (default: empty)
- --mqtt-broker: MQTT broker URL (default: tcp://localhost:1883)
- --heartbeat-interval: Heartbeat interval seconds (default: 1)
- --watchdog-timeout: Dead Man's Switch timeout seconds (default: 5)
- --http-port: Health endpoint port (default: 8081)

Log startup: "ORION Edge Agent v0.1.0 starting (device: {device_id})"
Log connections: "Connected to Redis at {addr}", "Connected to MQTT broker at {url}"

Do NOT implement Dead Man's Switch logic yet - that's Plan 03.
Do NOT implement kinematics - that's out of Phase 6 scope.
  </action>
  <verify>cd /home/orion/orion/edge && make build && ./bin/orion-edge --help</verify>
  <done>orion-edge binary builds, shows help with all flags, health endpoint works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd edge && go mod tidy && go mod verify` succeeds
- [ ] `cd edge && make build` produces bin/orion-edge
- [ ] `cd edge && make build-arm64` produces bin/orion-edge-arm64 (for Pi 4)
- [ ] `./bin/orion-edge --help` shows all 7 flags
- [ ] Binary starts without Redis/MQTT (fails fast with clear error)
- [ ] Health endpoint returns JSON with device_id when running
</verification>

<success_criteria>
- orion-edge-agent Go module initialized with correct dependencies
- Redis and MQTT clients implemented with connection handling
- Main binary builds for both local and ARM64 platforms
- Health endpoint operational
- Follows ORION Go patterns (flags, logging, graceful shutdown)
</success_criteria>

<output>
After completion, create `.planning/phases/06-edge-integration/06-02-SUMMARY.md`
</output>
